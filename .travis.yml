---
language: node_js
node_js:
  # lts/boron is the earliest LTS that npm v6 works on
  - "6"

sudo: false
dist: trusty

addons:
  chrome: stable
  code_climate:
    repo_token:
      secure: gQhPZkdkqJi1XbgJpe23Ji90VQCuXLV1yOp0L1JH+Hx4L19L+mn3gEbB99bFa/Lbh4ASwpuapHy6w2VUn6mzHknbD8r0me7g5bebGFcDyPf+EOVHEzAScnFHrKIqjK/sCbvcI7xWvDpzg9kT9UTBAdVfiJYEYiPEnKskPy8FIE0=

branches:
  only:
    - master # otherwise pull requests get built twice
    - v3 # for now

cache:
  directories:
  - "$HOME/.npm"

env:
  # build for LTS versions (https://www.emberjs.com/builds/)
  - COVERAGE=true
  - FIREBASE_SCENARIO=latest
  - FIREBASE_SCENARIO=next
  - FIREBASE_SCENARIO=canary
  - EMBER_SCENARIO=latest
  - EMBER_SCENARIO=beta
  - EMBER_SCENARIO=lts

matrix:
  fast_finish: true
  allow_failures:
    - env: FIREBASE_SCENARIO=canary
    - env: FIREBASE_SCENARIO=next
    - env: EMBER_SCENARIO=beta

before_install:
  # upgrade npm to get the "ci" command
  - npm i -g npm

install:
  - if [[ $FIREBASE_SCENARIO == 'latest' ]]; then npm i --save firebase@latest; fi
  - if [[ $FIREBASE_SCENARIO == 'next'   ]]; then npm i --save firebase@next; fi
  - if [[ $FIREBASE_SCENARIO == 'canary' ]]; then npm i --save firebase@canary; fi
  - if [[ $EMBER_SCENARIO == 'latest' ]]; then npm i --save-dev ember-source@latest ember-data@latest; fi
  - if [[ $EMBER_SCENARIO == 'beta' ]]; then npm i --save-dev ember-source@beta ember-data@beta; fi
  - if [[ $EMBER_SCENARIO == 'lts' ]]; then npm i --save-dev ember-source@lts ember-data@lts; fi
  - npm ci

script:
  - npm run test

after_script:
  - if [ "$COVERAGE" ]; then sed 's/SF:modules\/emberfire\//SF:addon\//g' coverage/lcov.info > coverage/lcov.info.fixed; fi
  - if [ "$COVERAGE" ]; then codeclimate-test-reporter < coverage/lcov.info.fixed; fi
