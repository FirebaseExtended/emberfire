---
language: node_js
node_js:
  # lts/boron is the earliest LTS that npm v6 works on
  - "6"

sudo: false
dist: trusty

addons:
  chrome: stable
  code_climate:
    repo_token:
      secure: gQhPZkdkqJi1XbgJpe23Ji90VQCuXLV1yOp0L1JH+Hx4L19L+mn3gEbB99bFa/Lbh4ASwpuapHy6w2VUn6mzHknbD8r0me7g5bebGFcDyPf+EOVHEzAScnFHrKIqjK/sCbvcI7xWvDpzg9kT9UTBAdVfiJYEYiPEnKskPy8FIE0=

branches:
  only:
    - master # otherwise pull requests get built twice
    - v3 # for now

cache:
  directories:
  - "$HOME/.npm"

env:
  # build for LTS versions (https://www.emberjs.com/builds/)
  - EMBER_TRY_SCENARIO=ember-lts-2.16
  - EMBER_TRY_SCENARIO=ember-lts-2.18
  - EMBER_TRY_SCENARIO=ember-lts-3.4
  - EMBER_TRY_SCENARIO=ember-default COVERAGE=true
  - FIREBASE_SCENARIO=firebase-latest EMBER_TRY_SCENARIO=ember-default
  - FIREBASE_SCENARIO=firebase-next EMBER_TRY_SCENARIO=ember-default
  - FIREBASE_SCENARIO=firebase-canary EMBER_TRY_SCENARIO=ember-default
  - EMBER_TRY_SCENARIO=ember-beta
  - EMBER_TRY_SCENARIO=ember-canary

matrix:
  fast_finish: true
  allow_failures:
    - env: EMBER_TRY_SCENARIO=ember-canary
    - env: FIREBASE_SCENARIO=firebase-canary EMBER_TRY_SCENARIO=ember-default
    - env: EMBER_TRY_SCENARIO=ember-beta

before_install:
  # upgrade npm to get the "ci" command
  - npm i -g npm

install:
  - npm ci
  - if [[ $FIREBASE_SCENARIO == 'firebase-latest' ]]; then npm i --save firebase@latest; fi
  - if [[ $FIREBASE_SCENARIO == 'firebase-next'   ]]; then npm i --save firebase@next; fi
  - if [[ $FIREBASE_SCENARIO == 'firebase-canary' ]]; then npm i --save firebase@canary; fi

script:
  - npm run ts:precompile
  - node_modules/.bin/ember try:one $EMBER_TRY_SCENARIO --skip-cleanup

after_script:
  - if [ "$COVERAGE" ]; then sed 's/SF:modules\/emberfire\//SF:addon\//g' coverage/lcov.info > coverage/lcov.info.fixed; fi
  - if [ "$COVERAGE" ]; then codeclimate-test-reporter < coverage/lcov.info.fixed; fi
